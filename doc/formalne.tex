\chapter{Code-breaking Games}

%-------------------------------------------------------------------------------
% DEF: CODE BREAKING GAME
%\section{Formal definition}

\TODO{Motivace: Ve hře chci najít přiřazení proměnných. Hru tedy reprezentuju jako
mnozinu promennych, a jakousi mnozinu experimentu. Po provedeni experimentu
dostanu formuli v danych promennych, o ktere vim, ze je splnena v hledane valuaci.
Tato formule reprezentuje castecnou informaci, kterou jsem experimentem ziskal.
Kazdy experiment muze dopadnout vice zpusoby, pro kazdy mam tedy mnozinu
moznych formuli, ktere mi da.}

% Intuitively, the objective of the game is to find a valuation of
%   variables $\Var$ by a series of experiments.
% Let us call it \emph{the wanted valuation}.
% The search space is reduced by formula $\init$,
%   which is always known to be satisfied by the wanted valuation.

% Experiments consist of a type, which is from the set $\Expt$ and a
%   parametrization, which is a string of variables from $\Var$.
% The experiment relation $\Exp$ specifies all permitted parameterizations
%   for each type of experiment and, therefore, $\Exp$ is the set of
%   all possible experiments as pairs.

% The outcome function gives us the possible outcomes of an experiment.
%   We require that exactly one of them must be satisfied by every valuation
%   by which $\init$ is satisfied.

\TODO{
Pro kompaktni zapis reprezentuju experiment jako dvojici (typ experimentu, parametrizace),
kde parametrizace je retezec nad danou abecedou.
Pro kazdy typ experimentu pak mam mnozinu parametrizovanych formuli.}
This whole idea is formalized below.

\begin{definition} \label{def-game}
A \emph{code-breaking game} is a septuple
  $\game = (\Var, \init, \Expt, \Sigma, \Exp, F, \outcome)$, where
  \begin{itemize}
  \item $\Var$ is a finite set of propositional variables,
  \item $\init \in \Form_\Var$ is a satisfiable prepositional formula,
  \item $\Expt$ is a finite set of types of experiments,
  \item $\Sigma$ is a finite alphabet,
  \item $\Exp \subseteq \Expt \times \Sigma^\star$ is an \emph{experiment} relation,
  and
  \item $F$ is a finite collection of functions of type $\Sigma -> \Var$,
  \item $\outcome: \Expt -> 2^{\PForm_{\Var,F,\Sigma}}$ is an
  \emph{outcome function} such that $\outcome(\expt)$ is finite
  for any $\expt\in\Expt$. Definition of $\PForm$ follows (Definition \ref{def-pform}).
  \end{itemize}
\end{definition}

\begin{definition} \label{def-pform}
A set of \emph{parametrized formulas} $\PForm_{\Var,F,\Sigma}$ is a set of
 all strings $\pform$ generated by the following grammar:
$$ \pform ::= x \| f(\$n) \| \pform \circ \pform \| \neg \pform,$$
where $x\in\Var$, $f\in F$, $n \in\Nset$, and $\circ\in\{\wedge, \vee, =>\}$.
By $\pform(\param)$ we denote application of a parametrization $\param\in\Sigma^\star$
on a formula $\pform$, which is defined recursively on the stucture of $\pform$ in the following way:
\begin{align}
(x)(\param) &= x, \\
(f(\$n))(\param) &= \param[n],\\
(\pform_1\circ\pform_2)(\param) &= \pform_1(\param) \circ \pform_2(\param),\\
(\neg\pform)(\param) &= \neg(\pform(\param)).
\end{align}
\end{definition}

\TODO{Znak $\$$ v $f(\$n)$ je od toho, aby to nematlo, ze $n$ je argumentem funkce.}

\TODO{Poznamka o tom, ze tohle me neomezuje oproti popsane intuici. V nejhorsim muzu pro kazdy experiment udelat zvlastni typ.}

For the sake of simplicity, let us write $\outcome(\exp) = \{ \pform(\param) \| \pform\in\outcome(\expt)\}$ for any experiment
$\exp = (\expt, \param) \in \Exp$.

A code-breaking game is \emph{well-formed} if for all $(\expt, \param) \in \Exp$,
\begin{equation} \label{prop-outcome}
\forall\val\in\Val_\Var:  \val(\init) = 1 ==> \exists \textrm{ exactly one }\psi\in\outcome(\expt)\;.\; \val(\psi(\param)) = 1
\end{equation}

This guarantees that the result of every experiment is uniquely defined for any valuation.
Note that this property is not easy to check.
In sequel, we suppose a game to be well-fordmed, if not stated otherwise.

%-------------------------------------------------------------------------------
% EXAMPLE: FAKE-COIN PROBLEM

\begin{example}[Fake-coin problem] \label{form-fake-coin1}
Fake-coin problem with $n$ coins, one of which is fake, can be formalized as
a code breaking game
$\mathcal{F}_n = (\Var, \init, \Expt, \Sigma, \Exp, F, \outcome)$.

\begin{itemize}
\item
$\Var = \{x_1, x_2, ..., x_n, y\}$, \\
$\init = \exactly{1}(\{x_1, ..., x_n\})$. \\
Intuitively, variable $x_i$ tells weather the coin $i$ is fake.
Variable $y$ tells weather it is lighter or heavier.
Formule $\init$ says that exactly one coin is fake.

\item
$\Expt = \{ w_2, w_4, ..., w_n \}$, \\
$\Sigma = \{1, 2,...,n\}$, \\
$\Exp = \bigcup_{1<=m<=n/2} \{ (w_{2m}, \param) \|
  \param \in \{1,...,n\}^{2m}, \forall x\in\Var. \#_x(\param)<=1 \}. $\\
There are $n/2$ types of experiment -- according to the number of coins we put on the weights.
The alphabet contains natural numbers up to $n$ and
possible parametrizations for $w_{2m}$ are strings of length $2m$ with no repetitions.

\item
$F = \{ f_x \}$, where $f_x(i) = x_i$ for $1 <= i <= n$, \\
$\outcome(w_m) = $ \vspace{-4mm}
\begin{align*}
  \big\{
& ((f_x(\$1) \vee ... \vee f_x(\$m)) \wedge \neg y) \vee ((f_x(\$m+1) \vee ... \vee f_x(\$2m)) \wedge y), \\
& ((f_x(\$1) \vee ... \vee f_x(\$m)) \wedge y) \vee ((f_x(\$m+1) \vee ... \vee f_x(\$2m)) \wedge \neg y), \\
& \neg (f_x(\$1) \vee ... \vee f_x(\$2m)) \big\}.
\end{align*}
There are 3 possible outcomes of every experiment.
First, the right side is heavier. This happens if the fake coin is lighter and it appears in the first half of the parametrization, or if it is heavier and it appears in the second half. Second, analogously, the left side is heavier.
Third, the weights are balanced if the fake coin do not participate in the experiment.
\end{itemize}
\end{example}

%-------------------------------------------------------------------------------
% EXAMPLE: FAKE-COIN PROBLEM - alternative

\begin{example}[Fake-coin problem, alternative] \label{form-fake-coin2}
For demonstration purposes, here is another formalization of the same problem.
$\mathcal{F'}_n = (\Var, \init, \Expt, \Sigma, \Exp, F, \outcome)$.

\begin{itemize}
\item
$\Var = \{x_1, x_2, ..., x_n, y_1, y_2, ..., y_n\}$, \\
$\init = \exactly{1}(\{x_1, ..., x_n, y_1, ..., y_n \})$. \\
Variable $x_i$ tells that the coin $i$ is lighter, variable $y_i$ tells that the coin $i$ is heavier.
Formule $\init$ says that exactly one coin is different.

\item
$\Expt, \Sigma, \Exp$ is defined as in Example \ref{form-fake-coin1}.

\item
$F = \{ f_x, f_y \}$, where $f_x(i) = x_i$ and $f_y(i) = y_i$ for $1 <= i <= n$, \vspace{-1.5mm}
\begin{flalign*}
\outcome(w_m) = \big\{ & (f_x(\$1) \vee ... \vee f_x(\$m)) \vee (f_y(\$m+1) \vee ... \vee f_y(\$2m)), & \\
& (f_y(\$1) \vee ... \vee f_y(\$m)) \vee (f_x(\$m+1) \vee ... \vee f_x(\$2m)), & \\
& \neg (f_x(\$1) \vee ... \vee f_x(\$2m) \vee f_y(\$1) \vee ... \vee f_y(\$2m)) \big\}. &
\end{flalign*}
\end{itemize}
\end{example}

%-------------------------------------------------------------------------------
% EXAMPLE: MASTERMIND

\begin{example}[Mastermind]
\TODO{UPDATOVAT!}
Mastermind puzzle with $n$ pegs and color set $C$ can be formalized as
a code breaking game
$\mathcal{M}_{n,C} = (\Var, \init, \Expt, \Exp, \outcome)$, where

\begin{itemize}
\item
$\Var = \{x_{i,c} \| 1<=i<=n, c\in C\}$. \\
Variable $x_{i,c}$ tells whether there is the color $c$ at position $i$.
For simplicity, let us use the notation $\Var_c = \{ x_{i,c} \| 1<=i<=n \}$.

\item
$\init = \bigwedge\left\{
  \exactly{1} \{x_{i,c} \| c\in C\} \| 1<=i<=n\right\}$. \\
This guarantees that there is exactly one color at each position.

\item $\Expt = \{\expt\}$.\\
There is only one type of experiment -- guessing a combination.

\item $\Exp = \{(\expt, \param) \| \param = x_{1,c_1}x_{2,c_2}...x_{n,c_n}\}$.\\
Parametrization of $\expt$ can be any string of length $n$,
$i$-th symbol of which belongs to $\{ x_{i,c} \| c \in C\}$.

\item Inference function is defined by
\begin{align*}
\outcome(\val, (\expt, \param)) =\;
 & \exactly{b}\{ \param[i] \| 1<=i<=n \} \;\wedge \\
 & \exactly{t}\bigcup
      \big\{ \\
          & \{
                \atleast{k}\{ x_{i,c} \| 1<=i<=n \}
                \| 1 <= k <= \#i.(\param[i]\in\Var_c)
            \} \\
            & \| c\in C
      \big\}
\end{align*}
where $b = \# i . (\val(\param[i]) = 1)$ captures the number of black pegs
  in the response for the experiment $(t, p)$ and
  $t = \sum_{c\in C} \min( \#i.(v(x_{i,c}) = 1), \#i.(\param[i]\in\Var_c))$
  is the total number of pegs (black + white).

% TODO:
\TODO{Fakt to nejde nějak jednodušej?}
\end{itemize}
\end{example}

%-------------------------------------------------------------------------------
% DEF: STRATEGY
\section{Strategies}

\begin{definition}
A \emph{strategy} is a function $\stg: \Form_\Var -> \Exp$,
determining the next experiment for given accumulated knowledge,
such that
\[
\form_0 \equiv \form_1 ==> \stg(\form_0) = \stg(\form_1).
\]
\end{definition}

A strategy $\stg$ together with a valuation $\val$ (satisfying $\form_0$) induce
  a \emph{solving process}, which is an infinite sequence
\[
\procstg{\stg}{\val} = \form_0 \arrow{\exp_1} \form_1 \arrow{\exp_2}
  \form_2 \arrow{\exp_3} ...,
\]
where $\exp_i = \stg(\form_0 \wedge \form_1 \wedge ... \wedge \form_{i-1})$ and
$\form_i \in \outcome(\exp_i)$ and $\val(\form_i) = 1$,
for all $i\in\Nset$. Notice that due to the condition \ref{prop-outcome},
there is always exactly one such $\pform_i$.

For the sake of simplicity, let us write $\aform{k}$
instead of $\form_0 \wedge \form_1 \wedge ... \wedge \form_k$.

We define \emph{length} of the solving process,
  denoted $|\procstg{\stg}{\val}|$
  (despite the infinite length of the sequence),
  as the smallest $k\in\Nseto$ such that
  $\numval_\Var(\aform{k}) = 1$.
This corresponds to the point where we can uniquely
  determine the valuation used in the process
  (i.e. we can determine the secret code).
Note that it always holds $\numval(\aform{k}) > 0$ because
  $\val(\form_i) = 1$ for all $i\in\Nseto$.

The following lemma is a straightforward consequence
  of the memory-less nature of the games. It says that once a strategy
  gives us an experiment that yields no new information, we will never get
  any new information (using the strategy).

\begin{lemma}
If $\numval(\aform{k}) = \numval(\aform{k+1})$ for some $k\in\Nset$,
then $\numval(\aform{k}) = \numval(\aform{k+l})$ for any $l\in\Nset$.
\end{lemma}

\begin{proof}
If $\aform{k+1} = \aform{k} \wedge \form_{k+1}$
is satisfied by valuation $\val$, so must be $\aform{k}$.
Since $\numval(\aform{k}) = \numval(\aform{k+1})$, the sets of
valuations satisfying $\aform{k}$ and $\aform{k+1}$ must be exactly the same
and the formulas are thus equivalent. This implies
$\stg(\aform{k}) = \stg(\aform{k+1})$ and thus also $\form_{k+2} = \form_{k+1}$.
By induction, $\form_{k+l} = \form_{k+1}$ and $\aform{k+l} \equiv \aform{k}$
 for any $l\in\Nset$.\qed
\end{proof}

The \emph{worst-case number of experiments} $\lenmax{\stg}$
  of a strategy $\stg$ is the maximal length of the solving process
  $\procstg{\stg}{\val}$ over all valuations $\val$ by which $\form_0$ is satisfied,
  i.e.
  $\lenmax{\stg} = \max_{\val\in\Val_\Var, \val(\form_0) = 1} |\procstg{\stg}{\val}|$.
We say that a strategy $\stg$ \emph{solves the game} if $\lenmax{\stg}$ is finite.
The game is \emph{solvable} if there exists a strategy that solves the game.

\TODO{Není to jednoduchý, ale je to zajímavý?
Given a code-breaking game $\game$, decide whether $\game$ is solvable.}

\begin{definition}
A strategy $\stg$ is \emph{optimal} if
  $\lenmax{\stg} <= \lenmax{\stg'}$ for any strategy $\stg'$.
\end{definition}

\begin{definition}
Let $f: \Form_\Var -> \Zset$.
A strategy $\stg$ is \emph{$f$-greedy} if
  for every $\form\in\Form_X$ and $\exp'\in\Exp$,
\[
\max_{\formu \in \outcome(\stg(\form)), \SAT{\form\wedge\formu}} f(\form\wedge\formu) <=
\max_{\formu \in \outcome(e), \SAT{\form\wedge\formu}} f(\form\wedge\formu).
\]
In words, a greedy strategy minimizes
  the value of $f$ on the formula in the next step.

We say $\stg$ is \emph{greedy} if it is $\numval_\Var$-greedy.
\end{definition}


\begin{problem}
Given a code-breaking game $\game$,
  decide whether all greedy strategies are optimal.
Hypothesis: It is the case for Fake-coin problem (?).
  It is not the case for Mastermind[ref].
\end{problem}

%-------------------------------------------------------------------------------

\begin{definition}
An experiment $\exp_1$ is in relation $\sim_\form$ with an experiment $\exp_2$ if
 and only if there exists a permutation $\perm\in\Perm_\Var$ such that
 $ \{ \form\wedge\formu \| \formu\in\outcome(\exp_1) \} \equiv
   \{ (\form\wedge\formu)^\perm \| \formu\in\outcome(\exp_2) \} $.
\end{definition}

Meaning?