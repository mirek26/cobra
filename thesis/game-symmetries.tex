\section{Symmetries in Code Braking Games}

% The number of possible parametrizations of a type of experiment is typically very large,
%   which makes the analysis a game much harder.
% For example, consider the conterfeit-coin problem (\ref{prob-coins})
%   and the experiment of weighting 4 coins against 4 coins.
% There is $\frac{1}{2}\cdot {12 \choose 4}\cdot{8 \choose 4} = 17325$
%  possible combinations for parametrization, but
%  in the initial state (i.e. with no knowledge except for the initial restriction),
%  all of them are equivelent -- they will give us the same information regardless of symmetries.

% In this section, we formally define equivalence of two experiments
%  and show that we can neglect all but one experiment in each equivelence class.
% Further, we present several lemmas that will form the basis of
%  our symmetry breaking algorithms in the Chapter \ref{chapter-cobra}.

\begin{definition}[Symmetric experiment]
For an experiment $\exp = (\expt, \param)$ and a permutation $\perm\in\Perm_\Var$,
  a $\perm$-symmetric experiment $\exp^\perm = (\expt, \param')\in\Exp$
  is an experiment of the same type such that
  $\{\form^\perm \in\outcome(\exp)\} = \{\form\in\outcome(\exp^\perm)\}$.
Clearly, no such experiment may exists.
\end{definition}

\begin{definition}[Symmetry group]
We define a \emph{symmetry group} $\symg$ as
  the maximal subset of $\Perm_\Var$ such that for
  every $\perm\in\symg$ and for every experiment $\exp\in\Exp$,
  there exists a $\perm$-symmetric experiment $\exp^\perm$.
\end{definition}

\begin{definition}[Consistent strategy]
A memory-less strategy $\stg$ is \emph{consistent} if and only if
  for every $\form\in\Form_\Var$ and every $\perm\in\symg$, there
  exists $\permx\in\symg$ such that $\form^\perm \equiv \form^\permx$ and
  $\stg(\form^\permx) = \stg(\form)^\permx$.
\end{definition}

\TODO{Example, na kterém bude vidět, že jednoduchá definice nevyhovuje, protože můžu vzít symetrie $\form$ a dostanu, že to má dávat různé věci.}

\begin{lemma}
Let $\stgx$ be a memory-less strategy.
There exists a consistent memory-less strategy $\stg$ such that
  $\stglen{\tau}{\val} >= \stglen{\stg}{\val}$ for all $\val\in\Val_X$ satisfying $\init$.
\end{lemma}

\begin{proof}
\TODO{Idea: když chci nadefinovat $\stg(\form)$, kouknu na všechny $\val$, $k$, takové, že
  $\exists\perm\in\symg(\form^\perm = \stgknow{\stgx}{\val}{k})$, pro každý si spočítám
  $\stglen{\stgx}{\val} - k$ (tj. počet experimentů do konce) a vezmu minimum.}
\end{proof}

\begin{lemma} \label{lma-accruedknowledge}
Let $\stg$ be a consistent memory-less strategy and let $\val_1$, $\val_2$ be two models of $\init$.
If $\val_1$ is a model of $\stgknow{\stg}{\val_2}{k}$,
  then $\stgknow{\stg}{\val_1}{i} = \stgknow{\stg}{\val_2}{i}$
  for $i \in\Nseto$, $i <= k$.
\end{lemma}

\begin{proof}
Let $\proc_1 = \procstg{\stg}{\val_1}$, $\proc_2 = \procstg{\stg}{\val_2}$
and consider the first place where $\proc_1$ and $\proc_2$ differs.
It cannot be an experiment $\proc_1(i) \not= \proc_2(i)$ as they are both
  values of the same strategy on the same accrued knowledge:
$\proc_1(i) = \stg(\aknow{\proc_1}{i-1}) =
              \stg(\aknow{\proc_2}{i-1}) = \proc_2(i)$.

Suppose it is an outcome of the $i$-th experiment, $\proc_1[i] \not= \proc_2[i]$
  and $i <= k$.
Since $\val_1$ satisfies $\aknow{\proc_2}{k}$ and $i <= k$,
  it satisfies $\proc_2[i]$ as well.
However, $\val_1$ always satisfies $\proc_1[i]$ and
  both $\proc_1[i]$ and $\proc_2[i]$ are from the set
  $\outcome(\proc_1(i)) = \outcome(\proc_2(i))$.
Since there is exactly one satisfied experiment for each valuation in the set,
  $\proc_1[i]$ and $\proc_2[i]$ must be the same.
Contradiction. \qed
\end{proof}

\begin{definition}[Experiment equivalence]
An experiment $\exp_1\in\Exp$ is equivalent to $\exp_2\in\Exp$ with respect to $\form$,
  written $\exp_1\expeq{\form}\exp_2$,
  if and only if there exists a permutation $\perm\in\symg$ such that % nebo Perm_Var?
 $ \{ \form\wedge\formx \| \formx\in\outcome(\exp_1) \} \equiv
   \{ (\form\wedge\formx)^\perm \| \formx\in\outcome(\exp_2) \} $.
\end{definition}

\begin{theorem}
Let $\stg, \stgx$ be two consistent memory-less strategies, such that
$\stg(\form) \expeq{\form} \stgx(\form)$ for any $\form\in\Form_\Var$.
There is a bijection $f:\Val_\Var -> \Val_\Var$ such that
$\stglen{\stg}{\val} = \stglen{\stgx}{f(\val)}$.
\end{theorem}

\begin{proof}
First, we prove by induction for any $k\in\Nseto$,
  there is a permutation $\perm\in \symg$ such that
  $(\stgknow{\stg}{\val}{k})^\perm = \stgknow{\stgx}{\val^\perm}{k}$.
  \TODO{Pozděj pak možná potřebuju, že to platí každý $i<=k$..}
For better readability, let
  $\know_k = \stgknow{\stg}{\val}{k}$ and
  $\knowx_{k, \perm} = \stgknow{\stgx}{\val^\perm}{k}$

For $k=0$, take $\perm = \idperm_\Var$.
Clearly, $\stgknow{\stg}{\val}{0} = \init = \stgknow{\stgx}{\val^\idperm}{0}$.

For the induction step, suppose $\know_k^\perm = \knowx_{k, \perm}$ and $\perm\in \symg$.
Let $e_1 = \stg(\know_k)$, $e_2 = \stgx(\knowx_{k, \perm})$. It holds
\begin{equation}
e_2 = \stgx(\knowx_{k, \perm})
    \expeq{\knowx_{k, \perm}}  \stg(\knowx_{k, \perm})
    \stackrel{IH}{=} \stg(\know_k^\perm)
    \stackrel{cons.}{=} \stg(\know_k)^\perm
    = e_1^\perm \label{eq:expsym}\tag{$\sim$}
\end{equation}

and, therefore, there exists $\permx\in\symg$ such that
\begin{align}
 \{ \knowx_{k, \perm} \wedge \formx \| \formx\in\outcome(\exp_2) \} &= %\stackrel{(\refeq{eq:expsym})}{=}
 \{ (\knowx_{k, \perm} \wedge \formx)^\permx \| \formx\in\outcome(\exp_1^\perm) \} = \label{eq:sets}\tag{*}\\
&= \{ (\know_k^\perm \wedge \formx^\perm)^\permx \| \formx\in\outcome(\exp_1) \} =
 \{ (\know_k \wedge \formx)^{\perm\permx} \| \formx\in\outcome(\exp_1) \}
\end{align}
As $\permx\in\symg$ and $\symg$ is a permutation group, $\perm\permx\in\symg$.

Since the game is well-formed,
  $v$ satisfies exactly one formula in
  $\{ \know_k \wedge \formx \| \formx\in\outcome(\exp_1) \}$.
Therefore $v^{\perm\permx}$ satisfies exactly one formula
  in
  $\{ (\know_k \wedge \formx)^{\perm\permx} \| \formx\in\outcome(\exp_1) \}  =
   \{ \knowx_{k, \perm} \wedge \formx \| \formx\in\outcome(\exp_2) \}$,
  which means that $v^{\perm\permx}$ satisfies $\knowx_{k, \perm}$.
From Lemma \ref{lma-accruedknowledge}, $\knowx_{k, \perm} = \knowx_{k, \perm\permx}$.
Both $\know_{k+1}^{\perm\permx}$ and $\knowx_{k+1, \perm\permx}$ is thus the only
  formula from (\refeq{eq:sets}) satisfied by $v^{\perm\permx}$ and
  the induction is complete.

% Now for a fixed $\val$, take $k = \stglen{\stg}{\val}$, take
%   $\perm\in\symg$ such that
%   $(\stgknow{\stg}{\val}{k})^\perm = \stgknow{\stgx}{\val^\perm}{k}$
%   and define $f(\val) = \val^\perm$.
% Since
%  $(\stgknow{\stg}{\val}{i})^\perm = \stgknow{\stgx}{f(\val)}{i}$
%  for $i <= k$
%  and variable permutation preserves the number of models of a formula, i.e.
%   $\numval{\form} = \numval{\form^\perm}$ for any
%   $\form\in\Form_\Var$, $\perm\in\Perm_\Var$,
%  we have
%   $\stglen{\stg}{\val} = \stglen{\stgx}{f(\val)}$.
% \TODO{It remains to show that $f$ is a bijection.}
  % Suppose $f$ is not injective, and $f(\val_1) = f(\val_2)$.
  % By definition, the only model of
  \qed
\end{proof}

\begin{corollary}
Let $\stg_1, \stg_2$ be two consistent memory-less strategies, such that
  $\stg_1(\form) \expeq{\form} \stg_2(\form)$ for any $\form\in\Form_\Var$.
Then $\lenmax{\stg_1} = \lenmax{\stg_2}$
  and $\lenexp{\stg_1} = \lenexp{\stg_2}$.
\end{corollary}

% For any accrued knowledge $\form$, this lemma gives us the right
% to consider only one of the experiments
% $\exp_1, \exp_2$ if $\exp_1 \sim_\form \exp_2$.

% Now, we would love an algorithm that would, for a given formula $\form$,
% generate a set of experiment, such that there is exaclty one expriment
% from every equivalence class in $E/\sim_\form$.

% \TODO{...}

% For the following sections, let us fix an experiment type $t$.
% \subsection{Phase 1}

% \subsection{Phase 2}